<?php
//include(CORE_VIEWS."forms/form_default.view");

//Add all languages files
$objects_dir = Functions::getdir(USER_OBJECTS);
foreach($objects_dir as $object_dir){
	$lang_object = add_language(USER_OBJECTS.$object_dir);
	if(is_array($lang) && is_array($lang_view)){
				$lang = array_merge($lang,$lang_view); //Merge General translation with user view translation
				if(isset($lang_object)){
					if(is_array($lang_object))
						$lang = array_merge($lang,$lang_object);
				}
			}
		}

		$list_all_objects = True;
		include(CORE_DATAS."object.data");
		$object_data = $data;

		include(CORE_DATAS."url/commands.data");
		$action_data = $data;
//var_dump($data);

		if(isset($_["id"])){
			$selected_db = new Entity($object_name."_actions",Variable::actions_fields());
			$selected = $selected_db->getById($_["id"]);
			$selected = Variable::action_args($selected);
			$selected_actions = explode(" ",$selected["action"]);
			//var_dump($selected_actions);
	//Hack for empty array item
			array_pop($selected_actions);

	//Get selected objects / remove ""
			foreach($selected_actions as $key => $selected_action){
				$selected_action = substr($selected_action,1,-1);
				$selected_groups[$key]["action"] = $selected_action;
				$selected_actionlist = explode(";",$selected_action);
				$selected_groups[$key]["object"] = $selected_actionlist[0];
			}

			//var_dump($selected_groups);

			$form_name = "ID:".$_["id"];
			$hidden_input = [
			"type" => "hidden",
			"value" => $_["id"]
			];
			$nb_actions = count($selected_actions) - 1;
		}
		else{
			$selected = false;
			$selected_groups = false;
			$form_name = "New";
			$nb_actions = 0;
		}

		$form = new Form($form_name);

		$form->input([
			"type" => "text",
			"id" => "object_name",
			"name" => "Name",
			"placeholder" => "name",
			"selected" => $selected["object_name"],
			"required" => true
			]);

		include(CORE_VIEWS."forms/form_group.view");

		$form->input([
			"type" => "hidden",
			"id" => "nb_actions",
			"value" => $nb_actions
			]);

		$form->input([
			"type" => "chainedselect_buttons",
			"id" => "actions"
			]);

		$form->input([
			"type" => "chainedselect_header",
			"id" => "actions",
			"nb" => 0
			]);

		$form->input([
			"type" => "chainedselect_actions",
			"objects" => $object_data,
			"options" => $action_data,
			"selected" => $selected_groups[0],
			"nb" => 0
			]);



		$form->input([
			"type" => "newactions",
			]);

	
		if($nb_actions != 0){
			for($i=1;$i<count($selected_groups);$i++){
				$form->input([
					"type" => "chainedselect_header",
					"id" => "actions",
					"nb" => $i
					]);
				$form->input([
					"type" => "chainedselect_actions",
					"objects" => $object_data,
					"options" => $action_data,
					"selected" => $selected_groups[$i],
					"nb" => $i
					]);
			}
		}
		

		$form->input([
			"type" => "divclose",
			]);

		$form->display($tpl);
		$object_name = "actionsgroup";

		$table_headers[] = "Name";
		$table_headers[] = "Action";
		$table_datas[] = "object_name";
		$table_datas[] = "action";
		$action_name = $object_name."_actions";


		include(CORE_VIEWS."datatable/dbtable_actionsgroup.view");
